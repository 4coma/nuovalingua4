<ion-content>
  <div class="container">
    <!-- Mode association -->
    <div *ngIf="selectedMode === 'association' && !exerciseCompleted && currentPairs.length > 0" class="association-container">
      <!-- Progression pour le mode association -->
      <ion-card class="progress-card compact">
        <ion-card-content>
          <ion-progress-bar [value]="matchedPairs / (currentPairs.length / 2)"></ion-progress-bar>
          <p class="progress-text">Paires trouvées {{ matchedPairs }} / {{ currentPairs.length / 2 }}</p>
        </ion-card-content>
      </ion-card>

      <!-- Jeu d'association -->
      <div class="game-grid">
        <ion-card 
          *ngFor="let pair of currentPairs" 
          [class]="getCardClass(pair)"
          (click)="selectWord(pair)"
          class="word-card game-card">
          <ion-card-content>
            <span class="word-text">{{ pair.word }}</span>
          </ion-card-content>
        </ion-card>
      </div>
    </div>

    <!-- En-tête avec statistiques (plus compact, sans titre principal) -->
    <ion-card *ngIf="selectedMode === 'writing' && !exerciseCompleted" class="stats-card compact">
      <ion-card-content>
        <div class="stats-grid">
          <div class="stat-item clickable" (click)="showAllTrackedWords()">
            <ion-icon name="book-outline"></ion-icon>
            <span>{{ stats.totalWords }} mots suivis</span>
          </div>
          <div class="stat-item clickable" (click)="showDueWords()">
            <ion-icon name="time-outline"></ion-icon>
            <span>{{ stats.dueForReview }} à réviser</span>
          </div>
          <div class="stat-item">
            <ion-icon name="trending-up-outline"></ion-icon>
            <span>EF moyen: {{ stats.averageEF.toFixed(1) }}</span>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Progression (mode écriture) -->
    <ion-card *ngIf="selectedMode === 'writing' && !exerciseCompleted && exerciseItems.length > 0" class="progress-card compact">
      <ion-card-content>
        <ion-progress-bar [value]="(currentIndex + 1) / exerciseItems.length"></ion-progress-bar>
        <p class="progress-text">Question {{ currentIndex + 1 }} / {{ exerciseItems.length }}</p>
        <p class="direction-text" *ngIf="currentIndex < exerciseItems.length">
          <ion-icon name="arrow-forward-outline"></ion-icon>
          {{ exerciseItems[currentIndex].direction === 'fr2it' ? 'Français → Italien' : 'Italien → Français' }}
        </p>
      </ion-card-content>
    </ion-card>

    <!-- Exercice en cours (mode écriture) -->
    <div *ngIf="selectedMode === 'writing' && !exerciseCompleted && currentIndex < exerciseItems.length && exerciseItems.length > 0" class="exercise-container compact">
      <ion-card class="word-card compact">
        <ion-card-content>
          <h2 class="word-display compact">{{ exerciseItems[currentIndex].question }}</h2>
          <p *ngIf="exerciseItems[currentIndex].wordPair.context" class="context compact">
            {{ exerciseItems[currentIndex].wordPair.context }}
          </p>
          <p *ngIf="exerciseItems[currentIndex].wordPair.category || exerciseItems[currentIndex].wordPair.topic" class="meta compact">
            {{ exerciseItems[currentIndex].wordPair.category }}<ng-container *ngIf="exerciseItems[currentIndex].wordPair.topic"> - {{ exerciseItems[currentIndex].wordPair.topic }}</ng-container>
          </p>
        </ion-card-content>
      </ion-card>

      <ion-item class="answer-input compact">
        <ion-label position="stacked">
          {{ exerciseItems[currentIndex].direction === 'fr2it' ? 'Écrivez le mot en italien' : 'Écrivez le mot en français' }}
        </ion-label>
        <ion-input
          [(ngModel)]="currentAnswer"
          (keyup.enter)="submitAnswer()"
          [disabled]="answerSubmitted"
          [placeholder]="exerciseItems[currentIndex].direction === 'fr2it' ? 'Traduisez en italien...' : 'Traduisez en français...'"
          type="text">
        </ion-input>
      </ion-item>

      <div class="voice-controls" *ngIf="!answerSubmitted">
        <ion-button size="small" [color]="getRecordingColor()" (click)="toggleRecording()" [disabled]="isTranscribing">
          <ion-icon [name]="getRecordingIcon()"></ion-icon>
        </ion-button>
        <ion-spinner name="crescent" *ngIf="isTranscribing"></ion-spinner>
      </div>

      <ion-button
        *ngIf="!answerSubmitted && currentAnswer.trim()"
        expand="block"
        color="primary"
        (click)="submitAnswer()"
        class="submit-button compact">
        <ion-icon name="checkmark-outline" slot="start"></ion-icon>
        Valider ma réponse
      </ion-button>
      <ion-button
        *ngIf="!answerSubmitted && !currentAnswer.trim()"
        expand="block"
        color="medium"
        (click)="passQuestion()"
        class="submit-button compact">
        <ion-icon name="play-skip-forward-outline" slot="start"></ion-icon>
        Passer
      </ion-button>

      <!-- Affichage de la réponse correcte -->
      <div *ngIf="answerSubmitted" class="answer-feedback compact">
        <ion-card [class]="isCorrect ? 'correct-answer' : 'incorrect-answer'">
          <ion-card-content>
            <div class="feedback-content">
              <ion-icon 
                [name]="isCorrect ? 'checkmark-circle' : 'close-circle'" 
                [color]="isCorrect ? 'success' : 'danger'"
                size="large">
              </ion-icon>
              <h3>{{ isCorrect ? 'Correct !' : 'Incorrect' }}</h3>
              <p><strong>Votre réponse :</strong> {{ currentAnswer }}</p>
              <p><strong>Réponse correcte :</strong> {{ exerciseItems[currentIndex].expectedAnswer }}</p>
            </div>
          </ion-card-content>
        </ion-card>
        <ion-button *ngIf="!isCorrect" expand="block" color="primary" (click)="nextQuestion()" class="next-question-btn" style="margin-top: 12px;">
          <ion-icon name="arrow-forward-outline" slot="start"></ion-icon>
          Suivant
        </ion-button>
      </div>
    </div>

    <!-- Nouvelle section : Récapitulatif de session et évaluation de facilité -->
    <div *ngIf="exerciseCompleted && reviewedWords.length > 0" class="recap-container">
      <ion-card class="recap-card">
        <ion-card-header>
          <ion-card-title>Évaluez la difficulté pour chaque mot</ion-card-title>
          <div class="recap-help">0 = très difficile, 1 = difficile, 2 = moyen, 3 = assez facile, 4 = facile, 5 = très facile</div>
        </ion-card-header>
        <ion-card-content>
          <div class="recap-list">
            <div *ngFor="let word of reviewedWords; let i = index" class="recap-item compact">
              <div class="recap-word compact">
                <span class="fr">{{ word.fr }}</span>
                <ion-icon name="arrow-forward-outline"></ion-icon>
                <span class="it">{{ word.it }}</span>
              </div>
              <div class="recap-quality compact">
                <ion-segment [(ngModel)]="word.quality" class="quality-segment full-width compact" mode="md">
                  <ion-segment-button *ngFor="let q of [0,1,2,3,4,5]" [value]="q">
                    <span>{{ q }}</span>
                  </ion-segment-button>
                </ion-segment>
              </div>
            </div>
          </div>
        </ion-card-content>
      </ion-card>
      <ion-button expand="block" color="primary" (click)="validateSession()" class="validate-session-btn">
        <ion-icon name="save-outline" slot="start"></ion-icon>
        Valider la session
      </ion-button>
      <div *ngIf="exerciseCompleted && reviewedWords.length > 0" class="spaced-repetition-actions" style="margin-top: 16px;">
        <ion-button expand="block" color="primary" (click)="launchComprehension('written')">
          <ion-icon name="book-outline" slot="start"></ion-icon>
          Compréhension écrite
        </ion-button>
        <ion-button expand="block" color="secondary" (click)="launchComprehension('oral')">
          <ion-icon name="volume-high-outline" slot="start"></ion-icon>
          Compréhension orale
        </ion-button>
        <ion-button *ngIf="hasRemainingWords" expand="block" color="tertiary" (click)="continueRevision()">
          <ion-icon name="repeat-outline" slot="start"></ion-icon>
          Continuer la révision
        </ion-button>
        <ion-button expand="block" color="medium" (click)="finishExercise()">
          <ion-icon name="home-outline" slot="start"></ion-icon>
          Retour au menu
        </ion-button>
      </div>
    </div>

    <!-- Ancienne section de fin de session masquée -->
    <div *ngIf="exerciseCompleted && reviewedWords.length === 0" class="completion-container">
      <ion-card class="completion-card">
        <ion-card-content>
          <div class="completion-content">
            <ion-icon name="checkmark-circle" size="large" color="success"></ion-icon>
            <h2>Session terminée !</h2>
            <p>Vous avez révisé {{ wordPairs.length }} mots selon l'algorithme de mémorisation espacée.</p>
            <p>Vos mots ont été mis à jour avec de nouveaux intervalles de révision.</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button 
        expand="block" 
        color="primary" 
        (click)="finishExercise()"
        class="finish-button">
        <ion-icon name="home-outline" slot="start"></ion-icon>
        Retour à l'accueil
      </ion-button>
    </div>

    <!-- Aucun mot à réviser -->
    <div *ngIf="exerciseItems.length === 0 && !exerciseCompleted" class="empty-container">
      <ion-card class="empty-card">
        <ion-card-content>
          <div class="empty-content">
            <ion-icon name="book-outline" size="large" color="medium"></ion-icon>
            <h2>Aucun mot à réviser</h2>
            <p>Continuez à utiliser l'application pour accumuler du vocabulaire !</p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button 
        expand="block" 
        color="primary" 
        (click)="finishExercise()"
        class="finish-button">
        <ion-icon name="home-outline" slot="start"></ion-icon>
        Retour à l'accueil
      </ion-button>
    </div>
  </div>
</ion-content> 