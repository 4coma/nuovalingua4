<ion-content>
  <div class="container ion-padding">
    <div class="header-section ion-text-center ion-margin-vertical">
      <h2>
        <ion-icon name="help-circle-outline"></ion-icon>
        Répondez aux questions
      </h2>
      <p>Ces questions portent sur le texte que vous venez de lire/écouter</p>
    </div>
    
    <!-- Lecteur audio pour réécouter (uniquement pour la compréhension orale) -->
    <ion-card *ngIf="comprehensionText && comprehensionText.type === 'oral'" class="audio-card">
      <ion-card-header>
        <ion-card-subtitle>Besoin de réécouter ?</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <app-audio-player [audioUrl]="audioUrl"></app-audio-player>
        
        <div class="transcription-control ion-margin-top">
          <ion-button (click)="toggleTranscription()" fill="outline" size="small">
            <ion-icon [name]="showTranscription ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
            {{ showTranscription ? 'Masquer la transcription' : 'Afficher la transcription' }}
          </ion-button>
        </div>
        
        <!-- Texte affiché uniquement si la transcription est activée -->
        <div *ngIf="showTranscription" class="transcription-container ion-margin-top">
          <div [innerHTML]="getHighlightedText() | safeHtml" 
               class="comprehension-text" 
               appSafeHtml
               (wordClick)="onWordClicked($event)"></div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Section des questions -->
    <ion-card>
      <ion-card-content>
        <form>
          <div *ngFor="let question of questions; let i = index" class="question-item ion-margin-vertical">
            <ion-item lines="none" class="ion-margin-bottom">
              <ion-label class="ion-text-wrap">
                <h2>Question {{i+1}}</h2>
                <p>{{question.question}}</p>
              </ion-label>
            </ion-item>
            
            <ion-item>
              <ion-textarea 
                [(ngModel)]="question.userAnswer" 
                name="answer{{i}}" 
                placeholder="Votre réponse..."
                rows="3"
                class="answer-input">
              </ion-textarea>
            </ion-item>
          </div>
          
          <div class="ion-text-center ion-margin-vertical">
            <ion-button (click)="submitAnswers()" expand="block" color="primary" [disabled]="isSubmitting">
              <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
              Valider mes réponses
            </ion-button>
          </div>
        </form>
      </ion-card-content>
    </ion-card>

    <!-- Résultats d'évaluation -->
    <ion-card *ngIf="showResult && evaluationResult">
      <ion-card-header>
        <ion-card-title class="ion-text-center">Évaluation</ion-card-title>
        <ion-card-subtitle class="ion-text-center">
          Score: {{evaluationResult.score}}%
        </ion-card-subtitle>
      </ion-card-header>
      
      <ion-card-content>
        <p class="ion-text-center ion-padding">{{evaluationResult.overallFeedback}}</p>
        
        <ion-list>
          <ion-item *ngFor="let feedback of evaluationResult.feedback" class="ion-margin-vertical">
            <ion-label class="ion-text-wrap">
              <h3>{{feedback.question}}</h3>
              <p><strong>Votre réponse:</strong> {{feedback.userAnswer}}</p>
              <p>
                <ion-chip [color]="feedback.isCorrect ? 'success' : 'danger'">
                  <ion-icon [name]="feedback.isCorrect ? 'checkmark-circle' : 'close-circle'"></ion-icon>
                  <ion-label>{{feedback.isCorrect ? 'Correct' : 'Incorrect'}}</ion-label>
                </ion-chip>
              </p>
              <p><strong>Explication:</strong> {{feedback.explanation}}</p>
              <p *ngIf="!feedback.isCorrect"><strong>Réponse correcte:</strong> {{feedback.correctAnswer}}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-card-content>
    </ion-card>

    <!-- Boutons de navigation -->
    <div class="ion-padding ion-text-center">
      <ion-button (click)="goBackToComprehension()" expand="block" color="medium" class="ion-margin-vertical">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Retour au texte
      </ion-button>
      
      <ion-button routerLink="/category" expand="block" color="tertiary" class="ion-margin-vertical">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        Retour aux catégories
      </ion-button>
    </div>
  </div>
  
  <!-- Modal de traduction contextuelle -->
  <ion-modal [isOpen]="!!translation" [backdropDismiss]="true" (didDismiss)="translation = null">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Traduction</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="translation = null">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>
      <ion-content class="ion-padding">
        <div *ngIf="isTranslating" class="ion-text-center">
          <ion-spinner></ion-spinner>
          <p>Traduction en cours...</p>
        </div>
        
        <div *ngIf="translation && !isTranslating">
          <h2 class="ion-text-center">{{ translation.originalWord }}</h2>
          
          <ion-item lines="none">
            <ion-label>
              <h3>Traduction</h3>
              <p class="translation">{{ translation.translation }}</p>
            </ion-label>
          </ion-item>
          
          <ion-item lines="none">
            <ion-label>
              <h3>Sens dans ce contexte</h3>
              <p>{{ translation.contextualMeaning }}</p>
            </ion-label>
          </ion-item>
          
          <ion-item *ngIf="translation.partOfSpeech" lines="none">
            <ion-label>
              <h3>Catégorie grammaticale</h3>
              <p>{{ translation.partOfSpeech }}</p>
            </ion-label>
          </ion-item>
          
          <div *ngIf="translation.examples && translation.examples.length > 0" class="examples-section ion-padding-top">
            <h3>Exemples</h3>
            <ion-list>
              <ion-item *ngFor="let example of translation.examples">
                <ion-label text-wrap>{{ example }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
          
          <div class="ion-padding-top ion-text-center">
            <ion-button (click)="translation = null" color="medium">
              Fermer
            </ion-button>
          </div>
        </div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content> 