<ion-content>
  <div class="container" *ngIf="comprehensionText">
    <div class="exercise-header ion-padding ion-text-center">
      <h2>
        <ion-icon [name]="comprehensionText.type === 'written' ? 'book-outline' : 'mic-outline'"></ion-icon>
        {{ comprehensionText.type === 'written' ? 'Lisez le texte' : 'Écoutez le dialogue' }}
      </h2>
      <p>Les mots de vocabulaire sont mis en évidence</p>
    </div>

    <ion-card class="text-card">
      <ion-card-content>
        <!-- Nouvelle interface audio pour la compréhension orale -->
        <div *ngIf="comprehensionText.type === 'oral'" class="audio-section">
          <app-audio-player [audioUrl]="audioUrl" [isLoading]="isAudioLoading"></app-audio-player>
          
          <div class="transcription-control">
            <ion-button (click)="toggleTranscription()" fill="outline" size="small">
              <ion-icon [name]="showTranscription ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
              {{ showTranscription ? 'Masquer la transcription' : 'Afficher la transcription' }}
            </ion-button>
          </div>
          
          <!-- Texte affiché uniquement si la transcription est activée -->
          <div *ngIf="showTranscription" class="transcription-container">
            <div [innerHTML]="getHighlightedText() | safeHtml" 
                 class="comprehension-text" 
                 appSafeHtml
                 (wordClick)="onWordClicked($event)"></div>
            <button *ngIf="selectedFragment" class="translate-fixed-btn" (click)="translateSelection()">
              Traduire la sélection
            </button>
          </div>
        </div>
        
        <!-- Affichage normal pour la compréhension écrite -->
        <div *ngIf="comprehensionText.type === 'written'" 
             [innerHTML]="getHighlightedText() | safeHtml" 
             class="comprehension-text" 
             appSafeHtml
             (wordClick)="onWordClicked($event)"></div>
        <button *ngIf="selectedFragment" class="translate-fixed-btn" (click)="translateSelection()">
          Traduire la sélection
        </button>
      </ion-card-content>
    </ion-card>

    <!-- Modal de traduction contextuelle -->
    <ion-modal [isOpen]="!!translation" [backdropDismiss]="true" (didDismiss)="closeTranslation()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="primary">
            <ion-title>Traduction</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeTranslation()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <div *ngIf="isTranslating" class="ion-text-center">
            <ion-spinner></ion-spinner>
            <p>Traduction en cours...</p>
          </div>
          
          <div *ngIf="translation && !isTranslating">
            <h2 class="ion-text-center">{{ translation.originalWord }}</h2>
            
            <ion-item>
              <ion-label position="stacked">Traduction</ion-label>
              <ion-input 
                [(ngModel)]="editableTranslation" 
                placeholder="Traduction"
                type="text">
              </ion-input>
            </ion-item>
            
            <ion-item lines="none">
              <ion-label>
                <h3>Sens dans ce contexte</h3>
                <p>{{ translation.contextualMeaning }}</p>
              </ion-label>
            </ion-item>
            
            <ion-item *ngIf="translation.partOfSpeech" lines="none">
              <ion-label>
                <h3>Catégorie grammaticale</h3>
                <p>{{ translation.partOfSpeech }}</p>
              </ion-label>
            </ion-item>
            
            <div *ngIf="translation.examples && translation.examples.length > 0" class="examples-section ion-padding-top">
              <h3>Exemples</h3>
              <ion-list>
                <ion-item *ngFor="let example of translation.examples">
                  <ion-label text-wrap>{{ example }}</ion-label>
                </ion-item>
              </ion-list>
            </div>
            
            <div class="ion-padding-top ion-text-center">
              <ion-button (click)="addWordToDictionary()" color="success" class="ion-margin-end" [disabled]="!editableTranslation">
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                Ajouter au dictionnaire
              </ion-button>
              <ion-button (click)="closeTranslation()" color="medium">
                Fermer
              </ion-button>
            </div>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <div class="vocabulary-list ion-padding">
      <h3 class="ion-text-center">Vocabulaire</h3>
      <ion-list>
        <ion-item *ngFor="let item of comprehensionText.vocabularyItems" button (click)="getWordTranslation(item.word)">
          <ion-label>
            <h2>{{ item.word }}</h2>
            <p>{{ item.translation }}</p>
          </ion-label>
          <ion-icon name="information-circle-outline" slot="end"></ion-icon>
        </ion-item>
      </ion-list>
    </div>

    <!-- Section des questions intégrée -->
    <div class="questions-section ion-padding">
      
      <!-- Affichage du chargement pendant la génération des questions -->
      <div *ngIf="isGeneratingQuestions" class="ion-text-center">
        <ion-spinner></ion-spinner>
        <p>Génération des questions en cours...</p>
      </div>
      
      <!-- Si les questions n'existent pas encore, afficher le bouton pour les générer -->
      <div *ngIf="!comprehensionText?.questions?.length && !isGeneratingQuestions" class="ion-text-center">
        <ion-button (click)="generateQuestions()" expand="block" color="success">
          <ion-icon name="help-circle-outline" slot="start"></ion-icon>
          Générer des questions
        </ion-button>
      </div>
      
      <!-- Si les questions existent, les afficher directement ici -->
      <div *ngIf="comprehensionText?.questions?.length">
        <ion-card>
          <ion-card-header>
            <ion-card-title class="ion-text-center">
              <ion-icon name="help-circle-outline"></ion-icon>
              Questions de compréhension
            </ion-card-title>
            <ion-card-subtitle class="ion-text-center">
              Répondez aux questions en vous référant au texte ci-dessus
            </ion-card-subtitle>
          </ion-card-header>
          
          <ion-card-content>
            <form>
              <div *ngFor="let question of comprehensionText.questions; let i = index" class="question-item ion-margin-vertical">
                <ion-item lines="none" class="ion-margin-bottom">
                  <ion-label class="ion-text-wrap">
                    <h2>Question {{i+1}}</h2>
                    <p>{{question.question}}</p>
                  </ion-label>
                </ion-item>
                
                <ion-item>
                  <ion-textarea 
                    [(ngModel)]="question.userAnswer" 
                    name="answer{{i}}" 
                    placeholder="Votre réponse..."
                    rows="3"
                    class="answer-input">
                  </ion-textarea>
                </ion-item>
              </div>
              
              <div class="ion-text-center ion-margin-vertical">
                <ion-button (click)="submitAnswers()" expand="block" color="primary" [disabled]="isSubmitting">
                  <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
                  Valider mes réponses
                </ion-button>
              </div>
            </form>
          </ion-card-content>
        </ion-card>
        
        <!-- Résultats d'évaluation -->
        <ion-card *ngIf="showResult && evaluationResult">
          <ion-card-header>
            <ion-card-title class="ion-text-center">Évaluation</ion-card-title>
            <ion-card-subtitle class="ion-text-center">
              Score: {{evaluationResult.score}}%
            </ion-card-subtitle>
          </ion-card-header>
          
          <ion-card-content>
            <p class="ion-text-center ion-padding">{{evaluationResult.overallFeedback}}</p>
            
            <ion-list>
              <ion-item *ngFor="let feedback of evaluationResult.feedback" class="ion-margin-vertical">
                <ion-label class="ion-text-wrap">
                  <h3>{{feedback.question}}</h3>
                  <p><strong>Votre réponse:</strong> {{feedback.userAnswer}}</p>
                  <p>
                    <ion-chip [color]="feedback.isCorrect ? 'success' : 'danger'">
                      <ion-icon [name]="feedback.isCorrect ? 'checkmark-circle' : 'close-circle'"></ion-icon>
                      <ion-label>{{feedback.isCorrect ? 'Correct' : 'Incorrect'}}</ion-label>
                    </ion-chip>
                  </p>
                  <p><strong>Explication:</strong> {{feedback.explanation}}</p>
                  <p *ngIf="!feedback.isCorrect"><strong>Réponse correcte:</strong> {{feedback.correctAnswer}}</p>
                </ion-label>
              </ion-item>
            </ion-list>
          </ion-card-content>
        </ion-card>
      </div>
    </div>
    
    <div class="ion-padding ion-text-center">
      <!-- Bouton de sauvegarde -->
      <ion-button 
        *ngIf="!isTextAlreadySaved()"
        (click)="saveText()" 
        expand="block" 
        color="success" 
        class="ion-margin-vertical">
        <ion-icon name="bookmark-outline" slot="start"></ion-icon>
        Sauvegarder ce texte
      </ion-button>
      
      <ion-button 
        *ngIf="isTextAlreadySaved()"
        expand="block" 
        color="success" 
        class="ion-margin-vertical"
        disabled>
        <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
        Texte déjà sauvegardé
      </ion-button>
      
      <ion-button (click)="finishExercise()" expand="block" color="medium" class="ion-margin-vertical">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Retour à l'exercice
      </ion-button>
      
      <ion-button routerLink="/category" expand="block" color="tertiary" class="ion-margin-vertical">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        Retour aux catégories
      </ion-button>
      
      <ion-button routerLink="/home" expand="block" color="light" class="ion-margin-vertical">
        <ion-icon name="home-outline" slot="start"></ion-icon>
        Retour à l'accueil
      </ion-button>
    </div>
  </div>
</ion-content>
