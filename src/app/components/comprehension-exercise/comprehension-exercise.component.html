<ion-content>
  <div class="container" *ngIf="comprehensionText">
    <div class="exercise-header ion-padding ion-text-center">
      <h2>
        <ion-icon [name]="comprehensionText.type === 'written' ? 'book-outline' : 'mic-outline'"></ion-icon>
        {{ comprehensionText.type === 'written' ? 'Lisez le texte' : 'Écoutez le dialogue' }}
      </h2>
      <p>Les mots de vocabulaire sont mis en évidence</p>
    </div>

    <ion-card class="text-card">
      <ion-card-content>
        <!-- Nouvelle interface audio pour la compréhension orale -->
        <div *ngIf="comprehensionText.type === 'oral'" class="audio-section">
          <app-audio-player [text]="comprehensionText.text"></app-audio-player>
          
          <div class="transcription-control">
            <ion-button (click)="toggleTranscription()" fill="outline" size="small">
              <ion-icon [name]="showTranscription ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
              {{ showTranscription ? 'Masquer la transcription' : 'Afficher la transcription' }}
            </ion-button>
          </div>
          
          <!-- Texte affiché uniquement si la transcription est activée -->
          <div *ngIf="showTranscription" class="transcription-container">
            <div [innerHTML]="getHighlightedText() | safeHtml" 
                 class="comprehension-text" 
                 appSafeHtml
                 (wordClick)="onWordClicked($event)"></div>
          </div>
        </div>
        
        <!-- Affichage normal pour la compréhension écrite -->
        <div *ngIf="comprehensionText.type === 'written'" 
             [innerHTML]="getHighlightedText() | safeHtml" 
             class="comprehension-text" 
             appSafeHtml
             (wordClick)="onWordClicked($event)"></div>
      </ion-card-content>
    </ion-card>

    <!-- Modal de traduction contextuelle -->
    <ion-modal [isOpen]="!!translation" [backdropDismiss]="true" (didDismiss)="closeTranslation()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="primary">
            <ion-title>Traduction</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeTranslation()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <div *ngIf="isTranslating" class="ion-text-center">
            <ion-spinner></ion-spinner>
            <p>Traduction en cours...</p>
          </div>
          
          <div *ngIf="translation && !isTranslating">
            <h2 class="ion-text-center">{{ translation.originalWord }}</h2>
            
            <ion-item lines="none">
              <ion-label>
                <h3>Traduction</h3>
                <p class="translation">{{ translation.translation }}</p>
              </ion-label>
            </ion-item>
            
            <ion-item lines="none">
              <ion-label>
                <h3>Sens dans ce contexte</h3>
                <p>{{ translation.contextualMeaning }}</p>
              </ion-label>
            </ion-item>
            
            <ion-item *ngIf="translation.partOfSpeech" lines="none">
              <ion-label>
                <h3>Catégorie grammaticale</h3>
                <p>{{ translation.partOfSpeech }}</p>
              </ion-label>
            </ion-item>
            
            <div *ngIf="translation.examples && translation.examples.length > 0" class="examples-section ion-padding-top">
              <h3>Exemples</h3>
              <ion-list>
                <ion-item *ngFor="let example of translation.examples">
                  <ion-label text-wrap>{{ example }}</ion-label>
                </ion-item>
              </ion-list>
            </div>
            
            <div class="ion-padding-top ion-text-center">
              <ion-button (click)="addWordToDictionary()" color="success" class="ion-margin-end">
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                Ajouter au dictionnaire
              </ion-button>
              <ion-button (click)="closeTranslation()" color="medium">
                Fermer
              </ion-button>
            </div>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <div class="vocabulary-list ion-padding">
      <h3 class="ion-text-center">Vocabulaire</h3>
      <ion-list>
        <ion-item *ngFor="let item of comprehensionText.vocabularyItems" button (click)="getWordTranslation(item.word)">
          <ion-label>
            <h2>{{ item.word }}</h2>
            <p>{{ item.translation }}</p>
          </ion-label>
          <ion-icon name="information-circle-outline" slot="end"></ion-icon>
        </ion-item>
      </ion-list>
    </div>
    
    <div class="ion-padding ion-text-center">
      <ion-button 
        *ngIf="!comprehensionText?.questions?.length" 
        (click)="generateQuestions()" 
        expand="block" 
        color="success" 
        class="ion-margin-vertical">
        <ion-icon name="help-circle-outline" slot="start"></ion-icon>
        Générer des questions
      </ion-button>
      
      <ion-button 
        *ngIf="comprehensionText?.questions?.length" 
        routerLink="/questions" 
        expand="block" 
        color="success" 
        class="ion-margin-vertical">
        <ion-icon name="help-circle-outline" slot="start"></ion-icon>
        Répondre aux questions
      </ion-button>
      
      <ion-button (click)="finishExercise()" expand="block" color="medium" class="ion-margin-vertical">
        <ion-icon name="arrow-back-outline" slot="start"></ion-icon>
        Retour à l'exercice
      </ion-button>
      
      <ion-button routerLink="/category" expand="block" color="tertiary" class="ion-margin-vertical">
        <ion-icon name="list-outline" slot="start"></ion-icon>
        Retour aux catégories
      </ion-button>
      
      <ion-button routerLink="/home" expand="block" color="light" class="ion-margin-vertical">
        <ion-icon name="home-outline" slot="start"></ion-icon>
        Retour à l'accueil
      </ion-button>
    </div>
  </div>
</ion-content>
