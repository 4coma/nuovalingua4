<ion-content>
  <div class="container" *ngIf="comprehensionText">
    <div class="exercise-header ion-text-center">
      <h2>
        {{ comprehensionText.type === 'written' ? 'Lisez le texte' : 'Écoutez le dialogue' }}
      </h2>
      <p>Les mots de vocabulaire sont mis en évidence</p>
    </div>

    <div class="text-content">
      <!-- Nouvelle interface audio pour la compréhension orale -->
      <div *ngIf="comprehensionText.type === 'oral'" class="audio-section">
        <app-audio-player [audioUrl]="audioUrl" [isLoading]="isAudioLoading"></app-audio-player>
        
        <div class="transcription-control">
          <ion-button (click)="toggleTranscription()" fill="outline" size="small">
            <ion-icon [name]="showTranscription ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
            {{ showTranscription ? 'Masquer la transcription' : 'Afficher la transcription' }}
          </ion-button>
        </div>
        
        <!-- Texte affiché uniquement si la transcription est activée -->
        <div *ngIf="showTranscription" class="transcription-container">
          <div [innerHTML]="getHighlightedText() | safeHtml" 
               class="comprehension-text" 
               appSafeHtml
               (wordClick)="onWordClicked($event)"></div>
          <button *ngIf="selectedFragment" class="translate-fixed-btn" (click)="translateSelection()">
            Traduire la sélection
          </button>
        </div>
      </div>
      
      <!-- Affichage normal pour la compréhension écrite -->
      <div *ngIf="comprehensionText.type === 'written'" 
           [innerHTML]="getHighlightedText() | safeHtml" 
           class="comprehension-text" 
           appSafeHtml
           (wordClick)="onWordClicked($event)"></div>
      <button *ngIf="selectedFragment" class="translate-fixed-btn" (click)="translateSelection()">
        Traduire la sélection
      </button>
    </div>

    <!-- Modal de consultation du dictionnaire -->
    <ion-modal [isOpen]="!!selectedDictionaryWord" [backdropDismiss]="true" (didDismiss)="closeDictionaryModal()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="success">
            <ion-title>
              <ion-icon name="bookmark" slot="start"></ion-icon>
              Mot du dictionnaire
            </ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeDictionaryModal()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding" *ngIf="selectedDictionaryWord">
          <div class="dictionary-word-header">
            <h2 class="ion-text-center">{{ selectedDictionaryWord.sourceWord }}</h2>
            <p class="ion-text-center translation-display">{{ selectedDictionaryWord.targetWord }}</p>
          </div>
          
          <ion-item lines="none" *ngIf="selectedDictionaryWord.contextualMeaning">
            <ion-label>
              <h3>Sens dans ce contexte</h3>
              <p>{{ selectedDictionaryWord.contextualMeaning }}</p>
            </ion-label>
          </ion-item>
          
          <ion-item lines="none" *ngIf="selectedDictionaryWord.partOfSpeech">
            <ion-label>
              <h3>Catégorie grammaticale</h3>
              <p>{{ selectedDictionaryWord.partOfSpeech }}</p>
            </ion-label>
          </ion-item>
          
          <div *ngIf="selectedDictionaryWord.examples && selectedDictionaryWord.examples.length > 0" class="examples-section ion-padding-top">
            <h3>Exemples</h3>
            <ion-list>
              <ion-item *ngFor="let example of selectedDictionaryWord.examples">
                <ion-label text-wrap>{{ example }}</ion-label>
              </ion-item>
            </ion-list>
          </div>
          
          <div *ngIf="selectedDictionaryWord.themes && selectedDictionaryWord.themes.length > 0" class="themes-section ion-padding-top">
            <h3>Thèmes</h3>
            <div class="themes-list">
              <ion-chip *ngFor="let theme of selectedDictionaryWord.themes" color="primary">
                {{ theme }}
              </ion-chip>
            </div>
          </div>
          
          <div class="ion-padding-top ion-text-center">
            <ion-button (click)="removeWordFromDictionaryModal()" color="danger" fill="outline" class="ion-margin-end">
              <ion-icon name="trash-outline" slot="start"></ion-icon>
              Retirer du dictionnaire
            </ion-button>
            <ion-button (click)="closeDictionaryModal()" color="medium">
              Fermer
            </ion-button>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <!-- Modal de traduction contextuelle -->
    <ion-modal [isOpen]="!!translation" [backdropDismiss]="true" (didDismiss)="closeTranslation()">
      <ng-template>
        <ion-header>
          <ion-toolbar color="primary">
            <ion-title>Traduction</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeTranslation()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding">
          <div *ngIf="isTranslating" class="ion-text-center">
            <ion-spinner></ion-spinner>
            <p>Traduction en cours...</p>
          </div>
          
          <div *ngIf="translation && !isTranslating">
            <h2 class="ion-text-center">{{ translation.originalWord }}</h2>
            
            <ion-item>
              <ion-label position="stacked">Traduction</ion-label>
              <ion-input 
                [(ngModel)]="editableTranslation" 
                placeholder="Traduction"
                type="text">
              </ion-input>
            </ion-item>
            
            <ion-item lines="none">
              <ion-label>
                <h3>Sens dans ce contexte</h3>
                <p>{{ translation.contextualMeaning }}</p>
              </ion-label>
            </ion-item>
            
            <ion-item *ngIf="translation.partOfSpeech" lines="none">
              <ion-label>
                <h3>Catégorie grammaticale</h3>
                <p>{{ translation.partOfSpeech }}</p>
              </ion-label>
            </ion-item>
            
            <div *ngIf="translation.examples && translation.examples.length > 0" class="examples-section ion-padding-top">
              <h3>Exemples</h3>
              <ion-list>
                <ion-item *ngFor="let example of translation.examples">
                  <ion-label text-wrap>{{ example }}</ion-label>
                </ion-item>
              </ion-list>
            </div>
            
              <div class="ion-padding-top ion-text-center">
              <ion-button (click)="addWordToDictionary()" color="success" class="ion-margin-end" [disabled]="!editableTranslation">
                <ion-icon name="add-circle-outline" slot="start"></ion-icon>
                Ajouter
              </ion-button>
              <ion-button (click)="closeTranslation()" color="medium">
                Fermer
              </ion-button>
            </div>
          </div>
        </ion-content>
      </ng-template>
    </ion-modal>

    <div class="results-container">
      <h3 class="ion-text-center">Vocabulaire</h3>
      <div class="exercise-option vocabulary-item" *ngFor="let item of comprehensionText.vocabularyItems">
        <div class="vocabulary-content" (click)="getWordTranslation(item.word)">
          <div class="option-title">{{ item.word }}</div>
          <div class="option-sub">{{ item.translation }}</div>
        </div>
        <ion-button 
          *ngIf="!isVocabularyItemInDictionary(item)"
          fill="clear" 
          size="small" 
          color="success"
          (click)="addVocabularyItemToDictionary(item, $event)"
          class="add-word-btn">
          <ion-icon name="add-circle-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button 
          *ngIf="isVocabularyItemInDictionary(item)"
          fill="clear" 
          size="small" 
          color="danger"
          (click)="removeVocabularyItemFromDictionary(item, $event)"
          class="remove-word-btn">
          <ion-icon name="remove-circle-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Section des questions intégrée -->
    <div class="results-container">
      <h3 class="ion-text-center">Questions de compréhension</h3>
      
      <!-- Affichage du chargement pendant la génération des questions -->
      <div *ngIf="isGeneratingQuestions" class="ion-text-center">
        <ion-spinner></ion-spinner>
        <p>Génération des questions en cours...</p>
      </div>
      
      <!-- Si les questions n'existent pas encore -->
      <div *ngIf="!comprehensionText?.questions?.length && !isGeneratingQuestions" class="exercise-option" (click)="generateQuestions()">
        Générer des questions
      </div>
      
      <!-- Si les questions existent -->
      <div *ngIf="comprehensionText?.questions?.length">
        <form>
          <div *ngFor="let question of comprehensionText.questions; let i = index" class="exercise-option question-item">
            <div class="option-title">Question {{i+1}}</div>
            <div class="option-sub">{{question.question}}</div>
            <ion-textarea 
              [(ngModel)]="question.userAnswer" 
              name="answer{{i}}" 
              placeholder="Votre réponse..."
              rows="3"
              class="answer-input">
            </ion-textarea>
          </div>
          
          <div class="exercise-option submit" (click)="!isSubmitting && submitAnswers()">
            Valider mes réponses
          </div>
        </form>
      
        <!-- Résultats d'évaluation -->
        <div class="evaluation-panel" *ngIf="showResult && evaluationResult">
          <div class="option-title ion-text-center">Évaluation</div>
          <div class="option-sub ion-text-center">Score: {{evaluationResult.score}}%</div>
          <p class="ion-text-center">{{evaluationResult.overallFeedback}}</p>
          <div class="feedback-list">
            <div class="feedback-item" *ngFor="let feedback of evaluationResult.feedback">
              <div class="option-title">{{feedback.question}}</div>
              <div class="option-sub"><strong>Votre réponse:</strong> {{feedback.userAnswer}}</div>
              <div class="option-sub"><strong>Explication:</strong> {{feedback.explanation}}</div>
              <div class="option-sub" *ngIf="!feedback.isCorrect"><strong>Réponse correcte:</strong> {{feedback.correctAnswer}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="results-container">
      <h3 class="ion-text-center">Actions</h3>
      
      <div class="exercise-option" *ngIf="!isTextAlreadySaved()" (click)="saveText()">
        Sauvegarder ce texte
      </div>
      <div class="exercise-option disabled" *ngIf="isTextAlreadySaved()">
        Texte déjà sauvegardé
      </div>

      <div class="exercise-option" (click)="finishExercise()">
        Retour
      </div>
      
      <div class="exercise-option" routerLink="/category">
        Retour aux catégories
      </div>
      
      <div class="exercise-option" routerLink="/home">
        Retour à l'accueil
      </div>
    </div>
  </div>
</ion-content>
