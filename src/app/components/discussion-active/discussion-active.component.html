<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="fullRevisionActive ? '/home' : '/discussion-context-selection'"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ currentContext?.title || 'Discussion' }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div style="padding: 20px;">
    
    <!-- Contexte de la discussion -->
    <ion-card *ngIf="currentContext">
      <ion-card-header>
        <ion-card-title>{{ currentContext.title }}</ion-card-title>
        <ion-card-subtitle>{{ currentContext.category }} - {{ currentContext.difficulty }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Situation:</strong> {{ currentContext.situation }}</p>
        <p><strong>Votre rôle:</strong> {{ currentContext.userRole }}</p>
        <p><strong>Rôle de l'IA:</strong> {{ currentContext.aiRole }}</p>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="fullRevisionActive">
      <ion-card-header>
        <ion-card-title>Vocabulaire ciblé</ion-card-title>
        <ion-card-subtitle>Utilise tous les mots pour terminer la session</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="revision-grid">
          <div class="revision-column">
            <h4>Tes mots</h4>
            <div class="chip-list">
              <ion-chip *ngFor="let word of userRevisionWords"
                        class="word-chip"
                        [color]="word.usedByUser ? 'success' : 'warning'"
                        [outline]="!word.usedByUser">
                <ion-label>{{ word.fr }}</ion-label>
              </ion-chip>
            </div>
            <ion-note color="medium">{{ remainingUserCount }} mot(s) restants pour toi</ion-note>
          </div>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Chargement initial -->
    <ion-card *ngIf="isStarting">
      <ion-card-content>
        <div style="text-align: center; padding: 20px;">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Préparation de la discussion...</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Messages de la discussion -->
    <div *ngIf="currentSession && currentSession.turns.length > 0">
      <div *ngFor="let turn of currentSession.turns; let i = index">
        <ion-card [class]="turn.speaker === 'ai' ? 'ai-message' : 'user-message'">
          <ion-card-content>
            <!-- Utilisation du composant TranslatableMessageComponent -->
            <app-translatable-message
              [message]="turn.message"
              [speaker]="turn.speaker"
              [speakerName]="turn.speaker === 'ai' ? (currentContext?.aiRole || 'IA') : 'Vous'"
              [timestamp]="turn.timestamp"
              [showTimestamp]="true"
              [highlightWords]="turn.highlightedWords || []">
            </app-translatable-message>
            
            <!-- Lecteur audio pour les messages IA -->
            <app-audio-player 
              *ngIf="turn.speaker === 'ai'" 
              [audioUrl]="turn.audioUrl || null" 
              [showControls]="true" 
              [isLoading]="isAudioGenerating(i, turn)"
              style="margin-top: 8px; background: transparent; box-shadow: none;">
            </app-audio-player>

            <div *ngIf="turn.speaker === 'ai' && isLastAiTurn(i) && fullRevisionActive && getRemainingUserWords().length > 0" class="remaining-user-words">
              <ion-note color="medium">Mots qu'il te reste à placer :</ion-note>
              <div class="chip-list">
              <ion-chip *ngFor="let word of getRemainingUserWords()"
                          color="warning"
                          [outline]="false"
                          class="word-chip">
                <ion-label>{{ word.fr }}</ion-label>
              </ion-chip>
            </div>
          </div>
          </ion-card-content>
        </ion-card>
        
        <!-- Feedback pour les messages utilisateur -->
        <app-message-feedback 
          *ngIf="turn.speaker === 'user' && turn.feedback" 
          [feedback]="turn.feedback">
        </app-message-feedback>
      </div>
    </div>

    <!-- Sélecteur de mode de réponse -->
    <ion-card *ngIf="!isStarting && currentSession && !isLoading" style="margin-bottom: 16px;">
      <ion-card-content>
        <ion-segment [(ngModel)]="responseMode" (ionChange)="onResponseModeChange()">
          <ion-segment-button value="voice">
            <ion-icon name="mic"></ion-icon>
            <ion-label>Vocal</ion-label>
          </ion-segment-button>
          <ion-segment-button value="text">
            <ion-icon name="create"></ion-icon>
            <ion-label>Écrit</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-card-content>
    </ion-card>

    <!-- Mode vocal -->
    <div *ngIf="responseMode === 'voice' && !isStarting && currentSession && !isLoading">
      <!-- Indicateur de traitement -->
      <ion-card *ngIf="isLoading" style="margin-bottom: 16px;">
        <ion-card-content>
          <div style="text-align: center; padding: 10px;">
            <ion-spinner name="crescent"></ion-spinner>
            <p style="margin: 8px 0 0 0; font-size: 14px;">
              {{ isRecording ? 'Arrêt de l\'enregistrement...' : 'Traitement en cours...' }}
            </p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button *ngIf="!isRecording && !isLoading" 
                  (click)="startRecording()" 
                  color="success" 
                  expand="block">
        <ion-icon name="mic" slot="start"></ion-icon>
        Commencer à parler
      </ion-button>
      <ion-button *ngIf="isRecording && !isLoading" 
                  (click)="stopRecording()" 
                  color="danger" 
                  expand="block">
        <ion-icon name="stop" slot="start"></ion-icon>
        Arrêter l'enregistrement
      </ion-button>
    </div>

    <!-- Mode écrit -->
    <div *ngIf="responseMode === 'text' && !isStarting && currentSession && !isLoading">
      <ion-card style="margin-bottom: 16px;">
        <ion-card-content>
          <ion-textarea
            [(ngModel)]="textResponse"
            placeholder="Tapez votre réponse ici..."
            rows="4"
            maxlength="500"
            [disabled]="isLoading"
            style="border: 1px solid #ccc; border-radius: 8px; padding: 12px;">
          </ion-textarea>
          <div style="text-align: right; margin-top: 8px; font-size: 12px; color: #666;">
            {{ textResponse.length }}/500 caractères
          </div>
        </ion-card-content>
      </ion-card>
      
      <ion-button 
        (click)="sendTextResponse()" 
        color="success" 
        expand="block"
        [disabled]="!textResponse.trim() || isLoading">
        <ion-icon name="send" slot="start"></ion-icon>
        Envoyer la réponse
      </ion-button>
    </div>

    <ion-button
      *ngIf="fullRevisionActive"
      expand="block"
      color="tertiary"
      class="ion-margin-vertical"
      (click)="goToEncoding()">
      <ion-icon name="create-outline" slot="start"></ion-icon>
      Passer à l'encodage
    </ion-button>

    <ion-note *ngIf="fullRevisionActive && remainingUserCount > 0" color="warning" class="full-revision-progress">
      Il te reste {{ remainingUserCount }} mot(s) à placer dans la conversation.
    </ion-note>

    <!-- Bouton retour -->
    <ion-button [routerLink]="fullRevisionActive ? '/home' : '/discussion-context-selection'" 
                color="medium" 
                fill="outline" 
                expand="block"
                [disabled]="isLoading"
                style="margin-top: 16px;">
      <ion-icon name="arrow-back" slot="start"></ion-icon>
      {{ fullRevisionActive ? 'Retour à l\'accueil' : 'Retour à la sélection' }}
    </ion-button>

  </div>
</ion-content> 
