<ion-content [fullscreen]="true">
  <div class="discussion-container">
    
    <!-- Contexte de la discussion -->
    <ion-card *ngIf="currentContext">
      <ion-card-header>
        <ion-card-title>{{ currentContext.title }}</ion-card-title>
        <ion-card-subtitle>{{ currentContext.category }} - {{ currentContext.difficulty }}</ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <p><strong>Situation:</strong> {{ currentContext.situation }}</p>
        <p><strong>Votre rôle:</strong> {{ currentContext.userRole }}</p>
        <p><strong>Rôle de l'IA:</strong> {{ currentContext.aiRole }}</p>
      </ion-card-content>
    </ion-card>

    <ion-card *ngIf="targetVocabulary.length > 0" class="target-vocabulary-card">
      <ion-card-header>
        <ion-card-title>Vocabulaire ciblé</ion-card-title>
        <ion-card-subtitle *ngIf="targetVocabularyMeta">
          {{ targetVocabularyMeta.category }} - {{ targetVocabularyMeta.topic }}
        </ion-card-subtitle>
      </ion-card-header>
      <ion-card-content>
        <div class="chip-list">
          <ion-chip *ngFor="let vocab of targetVocabulary"
                    class="word-chip"
                    [color]="vocab.used ? 'success' : 'medium'"
                    [outline]="!vocab.used"
                    (click)="toggleVocab(vocab)"
                    [title]="vocab.showAlt ? vocab.word : vocab.translation">
            <ion-label>
              <span class="target-word">{{ vocab.showAlt ? vocab.word : vocab.translation }}</span>
            </ion-label>
          </ion-chip>
        </div>
        <ion-note color="medium" *ngIf="targetVocabularyMeta">
          {{ targetVocabularyMeta.totalCount }} mot(s) enregistrés pour cette session
        </ion-note>
      </ion-card-content>
    </ion-card>

    <!-- Chargement initial -->
    <ion-card *ngIf="isStarting">
      <ion-card-content>
        <div class="loading-content">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Préparation de la discussion...</p>
        </div>
      </ion-card-content>
    </ion-card>

    <!-- Messages de la discussion -->
    <div *ngIf="currentSession && currentSession.turns.length > 0">
      <div *ngFor="let turn of currentSession.turns; let i = index">
        <ion-card [class]="turn.speaker === 'ai' ? 'ai-message' : 'user-message'">
          <ion-card-content>
            <!-- Utilisation du composant TranslatableMessageComponent -->
            <app-translatable-message
              [message]="turn.message"
              [speaker]="turn.speaker"
              [speakerName]="turn.speaker === 'ai' ? (currentContext?.aiRole || 'IA') : 'Vous'"
              [timestamp]="turn.timestamp"
              [showTimestamp]="true"
              [highlightWords]="turn.highlightedWords || []">
            </app-translatable-message>
            
            <!-- Lecteur audio pour les messages IA -->
            <app-audio-player 
              *ngIf="turn.speaker === 'ai'" 
              [audioUrl]="turn.audioUrl || null" 
              [showControls]="true" 
              [isLoading]="isAudioGenerating(i, turn)"
              class="audio-player-wrapper">
            </app-audio-player>

            <div *ngIf="turn.speaker === 'ai' && isLastAiTurn(i) && fullRevisionActive && getRemainingUserWords().length > 0" class="remaining-user-words">
              <ion-note color="medium">Mots qu'il te reste à placer :</ion-note>
              <div class="chip-list">
              <ion-chip *ngFor="let word of getRemainingUserWords()"
                          color="warning"
                          [outline]="false"
                          class="word-chip">
                <ion-label>{{ word.fr }}</ion-label>
              </ion-chip>
            </div>
          </div>
          </ion-card-content>
        </ion-card>
        
        <!-- Feedback pour les messages utilisateur -->
        <app-message-feedback 
          *ngIf="turn.speaker === 'user' && turn.feedback" 
          [feedback]="turn.feedback">
        </app-message-feedback>
      </div>
    </div>

    <!-- Sélecteur de mode de réponse -->
    <ion-card *ngIf="!isStarting && currentSession && !isLoading" class="response-mode-card">
      <ion-card-content>
        <ion-segment [(ngModel)]="responseMode" (ionChange)="onResponseModeChange()">
          <ion-segment-button value="voice">
            <ion-icon name="mic"></ion-icon>
            <ion-label>Vocal</ion-label>
          </ion-segment-button>
          <ion-segment-button value="text">
            <ion-icon name="create"></ion-icon>
            <ion-label>Écrit</ion-label>
          </ion-segment-button>
        </ion-segment>
      </ion-card-content>
    </ion-card>

    <!-- Mode vocal -->
    <div *ngIf="responseMode === 'voice' && !isStarting && currentSession && !isLoading">
      <!-- Indicateur de traitement -->
      <ion-card *ngIf="isLoading" class="loading-card">
        <ion-card-content>
          <div class="loading-content">
            <ion-spinner name="crescent"></ion-spinner>
            <p class="loading-text">
              {{ isRecording ? 'Arrêt de l\'enregistrement...' : 'Traitement en cours...' }}
            </p>
          </div>
        </ion-card-content>
      </ion-card>

      <ion-button *ngIf="!isRecording && !isLoading" 
                  (click)="startRecording()" 
                  color="success" 
                  expand="block">
        <ion-icon name="mic" slot="start"></ion-icon>
        Parler
      </ion-button>
      <ion-button *ngIf="isRecording && !isLoading" 
                  (click)="stopRecording()" 
                  color="danger" 
                  expand="block">
        <ion-icon name="stop" slot="start"></ion-icon>
        Arrêter l'enregistrement
      </ion-button>
    </div>

    <!-- Mode écrit -->
    <div *ngIf="responseMode === 'text' && !isStarting && currentSession && !isLoading">
      <ion-card class="text-input-card">
        <ion-card-content>
          <ion-textarea
            [(ngModel)]="textResponse"
            placeholder="Tapez votre réponse ici..."
            rows="4"
            maxlength="500"
            [disabled]="isLoading"
            class="text-response-input">
          </ion-textarea>
          <div class="character-count">
            {{ textResponse.length }}/500 caractères
          </div>
        </ion-card-content>
      </ion-card>
      
      <ion-button 
        (click)="sendTextResponse()" 
        color="success" 
        expand="block"
        [disabled]="!textResponse.trim() || isLoading">
        <ion-icon name="send" slot="start"></ion-icon>
        Envoyer la réponse
      </ion-button>
    </div>

    <ion-button
      *ngIf="fullRevisionActive"
      expand="block"
      color="tertiary"
      class="ion-margin-vertical"
      (click)="goToEncoding()">
      <ion-icon name="create-outline" slot="start"></ion-icon>
      Passer à l'encodage
    </ion-button>

    <ion-note *ngIf="fullRevisionActive && remainingUserCount > 0" color="warning" class="full-revision-progress">
      Il te reste {{ remainingUserCount }} mot(s) à placer dans la conversation.
    </ion-note>

    <!-- Bouton retour -->
    <ion-button [routerLink]="fullRevisionActive ? '/home' : '/discussion-context-selection'" 
                color="medium" 
                fill="outline" 
                expand="block"
                [disabled]="isLoading"
                class="back-button">
      <ion-icon name="arrow-back" slot="start"></ion-icon>
      {{ fullRevisionActive ? 'Retour à l\'accueil' : 'Retour à la sélection' }}
    </ion-button>

  </div>
</ion-content> 
