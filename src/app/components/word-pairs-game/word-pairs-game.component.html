<ion-content>
  <div class="container ion-padding">
    <!-- Titre du jeu -->
    <h2 class="game-title" *ngIf="gameComplete">
      <ion-icon name="checkmark-circle-outline"></ion-icon>
      Bravo !
    </h2>

    <!-- Configuration pliable (si révision personnelle et jeu pas terminé) -->
    <div *ngIf="isPersonalDictionaryRevision && !gameComplete" class="configuration-section">
      <!-- Titre discret pour déplier/replier -->
      <div class="configuration-toggle" (click)="toggleConfiguration()">
        <span class="configuration-title">Options</span>
        <ion-icon [name]="showConfiguration ? 'chevron-up' : 'chevron-down'" class="toggle-icon"></ion-icon>
      </div>
      
      <!-- Options de configuration (dépliables) -->
      <div *ngIf="showConfiguration" class="configuration-options">
        <!-- Input pour le nombre de paires -->
        <div class="pairs-title">
          <ion-input 
            type="number" 
            [(ngModel)]="maxPairsToReview" 
            (ionInput)="onPairsCountChange($event)"
            [disabled]="matchedPairs > 0"
            min="3" 
            max="50"
            class="pairs-input">
          </ion-input>
          <span class="pairs-label">paires</span>
        </div>

        <!-- Filtrage par thèmes -->
        <div *ngIf="availableThemes.length > 0" class="theme-filter-inline">
          <ion-item lines="none">
            <ion-label position="stacked">Thèmes</ion-label>
            <ion-input 
              [(ngModel)]="themeInput" 
              (ionInput)="onThemeInputChange($event)"
              (ionFocus)="showAutocomplete = true"
              (ionBlur)="hideAutocomplete()"
              placeholder="Thème..."
              [disabled]="matchedPairs > 0">
            </ion-input>
          </ion-item>
          
          <!-- Autocomplete dropdown -->
          <div *ngIf="showAutocomplete && filteredThemes.length > 0" class="autocomplete-dropdown">
            <div 
              *ngFor="let theme of filteredThemes" 
              class="autocomplete-item"
              (click)="selectTheme(theme)">
              {{ theme }}
            </div>
          </div>
          
          <!-- Chiplist des thèmes sélectionnés -->
          <div *ngIf="selectedThemes.length > 0" class="selected-themes">
            <ion-chip 
              *ngFor="let theme of selectedThemes" 
              color="primary"
              (click)="removeTheme(theme)">
              {{ theme }}
              <ion-icon name="close-circle" slot="end"></ion-icon>
            </ion-chip>
          </div>
        </div>
      </div>
    </div>

    <!-- Informations du jeu -->
    <div class="game-info" *ngIf="!gameComplete && currentPairs && currentPairs.length > 0">
      <p>
        <span class="set-indicator">Set {{ currentPairsSet }}/{{ getTotalSets() }}</span>
        <!-- Bouton mute/unmute entre le set et les paires -->
        <ion-button 
          fill="clear" 
          size="small" 
          (click)="toggleAudio()" 
          class="audio-toggle-btn">
          <ion-icon [name]="audioEnabled ? 'volume-high-outline' : 'volume-mute-outline'"></ion-icon>
        </ion-button>
        <span class="progress-indicator">{{ matchedPairs }} / {{ currentPairs.length / 2 }} paires</span>
      </p>
      <ion-progress-bar [value]="matchedPairs / (currentPairs.length / 2)"></ion-progress-bar>
    </div>
    
    <div class="game-complete" *ngIf="gameComplete">
      <p>Vous avez terminé l'exercice d'association !</p>
      <ion-badge color="success">
        {{ totalPairs }} paires associées | {{ attempts }} tentatives
      </ion-badge>
    </div>

    <!-- Grille de jeu -->
    <div class="pairs-grid" *ngIf="!gameComplete && currentPairs && currentPairs.length > 0">
      <ion-grid>
        <ion-row>
          <!-- Colonne de mots sources (à gauche) -->
          <ion-col size="6">
            <div class="source-words">
              <ion-card 
                *ngFor="let pair of currentPairs | filter:'isSource':true" 
                class="word-card" 
                [class]="getCardClass(pair)"
                (click)="selectWord(pair)">
                <ion-card-content>
                  {{ pair.word }}
                </ion-card-content>
              </ion-card>
            </div>
          </ion-col>
          
          <!-- Colonne de mots cibles (à droite) -->
          <ion-col size="6">
            <div class="target-words">
              <ion-card 
                *ngFor="let pair of currentPairs | filter:'isSource':false" 
                class="word-card" 
                [class]="getCardClass(pair)"
                (click)="selectWord(pair)">
                <ion-card-content>
                  {{ pair.word }}
                </ion-card-content>
              </ion-card>
            </div>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Message d'erreur s'il n'y a pas de données -->
    <div class="no-data-message" *ngIf="!currentPairs || currentPairs.length === 0">
      <ion-card>
        <ion-card-content class="ion-text-center">
          <ion-icon name="alert-circle-outline" size="large" color="warning"></ion-icon>
          <p>Aucune donnée de jeu disponible.</p>
          <ion-button routerLink="/category" expand="block" color="primary" class="ion-margin-top">
            Retour aux catégories
          </ion-button>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Section des actions (visible uniquement quand le jeu est terminé) -->
    <div class="actions-section" *ngIf="gameComplete">
      <!-- Section des mots révisés (visible uniquement pour la révision du dictionnaire personnel) -->
      <div class="revised-words-section" *ngIf="isPersonalDictionaryRevision && revisedWords.length > 0">
        <h3 class="ion-text-center">Mots révisés</h3>
        <p class="ion-text-center ion-text-muted">
          <small>Définissez quand ces mots pourront être révisés à nouveau</small>
        </p>
        
        <ion-list>
          <ion-item *ngFor="let word of revisedWords" class="revised-word-item">
            <ion-label>
              <h4>{{ word.sourceWord }} → {{ word.targetWord }}</h4>
              <p *ngIf="word.context" class="word-context">{{ word.context }}</p>
            </ion-label>
            <div class="word-controls">
              <ion-select 
                [(ngModel)]="word.revisionDelay" 
                (ionChange)="onRevisionDelayChange(word)"
                placeholder="Délai"
                interface="popover"
                class="revision-delay-select">
                <ion-select-option value="1j">1 jour</ion-select-option>
                <ion-select-option value="3j">3 jours</ion-select-option>
                <ion-select-option value="7j">7 jours</ion-select-option>
                <ion-select-option value="15j">15 jours</ion-select-option>
                <ion-select-option value="1m">1 mois</ion-select-option>
                <ion-select-option value="3m">3 mois</ion-select-option>
                <ion-select-option value="6m">6 mois</ion-select-option>
              </ion-select>
              <ion-toggle 
                [(ngModel)]="word.isKnown" 
                (ionChange)="onKnownStatusChange(word)"
                class="known-toggle">
                <ion-label>Connu</ion-label>
              </ion-toggle>
            </div>
          </ion-item>
        </ion-list>
        
        <p class="ion-text-center ion-text-muted ion-margin-top">
          <small>Les délais de révision seront sauvegardés automatiquement quand vous quitterez cet écran</small>
        </p>
      </div>

      <!-- Menu principal simplifié -->
      <div class="main-actions">
        <ion-button
          *ngIf="isFullRevisionSession"
          (click)="goToFullRevisionConversation()"
          expand="block"
          color="success"
          class="main-button">
          <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
          Passer à la conversation
        </ion-button>

        <ion-note *ngIf="isFullRevisionSession" color="medium" class="full-revision-note">
          La conversation guidée s'ouvre lorsque l'association est terminée.
        </ion-note>

        <!-- Bouton Plus pour afficher/masquer les options -->
        <div class="more-options-text" (click)="toggleMoreOptions()">
          {{ showMoreOptions ? 'Moins d\'options' : 'Plus d\'options' }}
        </div>
        
        <!-- Options supplémentaires (affichées conditionnellement) -->
        <div class="additional-options" *ngIf="showMoreOptions">
          <!-- Options sous forme de texte simple -->
          <div class="option-text" (click)="openDictionaryModal()">
            Ajouter au dictionnaire personnel
          </div>
          
          <div class="option-text" (click)="restartExercise()">
            Recommencer l'exercice
          </div>
          
          <div class="option-text" 
               (click)="restartFailedWords()" 
               [class.disabled]="!hasFailedWords">
            Recommencer les mots ratés ({{ failedWords.length }})
          </div>
          
          <div class="option-text" 
               (click)="generateWrittenComprehension()" 
               [class.disabled]="isGenerating">
            Compréhension écrite
          </div>
          
          <div class="option-text" 
               (click)="generateOralComprehension()" 
               [class.disabled]="isGenerating">
            Compréhension orale
          </div>
          
          <div class="option-text" (click)="goToVocabularyExercise()">
            Exercice d'encodage
          </div>
          
          <!-- Indicateur de chargement pour la génération -->
          <div *ngIf="isGenerating" class="loading-container ion-text-center ion-margin-vertical">
            <ion-spinner></ion-spinner>
            <p>Génération du texte en cours...</p>
          </div>
        </div>
        
        <!-- Boutons principaux toujours visibles -->
        <div class="main-option-text" (click)="navigateToCategory()">
          Retour aux catégories
        </div>
        
        <div class="main-option-text" (click)="navigateToHome()">
          Retour à l'accueil
        </div>
      </div>
    </div>
  </div>
</ion-content> 
