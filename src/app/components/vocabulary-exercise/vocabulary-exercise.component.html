<ion-content>
  <div class="container" *ngIf="sessionInfo">
    <div class="exercise-header">
      <h2 *ngIf="sessionInfo.category !== sessionInfo.topic">{{ sessionInfo.category }} - {{ sessionInfo.topic }}</h2>
      <h2 *ngIf="sessionInfo.category === sessionInfo.topic">{{ sessionInfo.category }}</h2>
      <ion-progress-bar [value]="(currentIndex + 1) / quizItems.length"></ion-progress-bar>
      <p class="progress-text">Mot {{ currentIndex + 1 }} / {{ quizItems.length }}</p>
    </div>

    <div *ngIf="!quizCompleted && quizItems.length > 0" class="question-container">
      <div class="word-card">
        <h1>{{ quizItems[currentIndex].sourceWord }}</h1>
        <p *ngIf="quizItems[currentIndex].question.context" class="context">
          Contexte: {{ quizItems[currentIndex].question.context }}
        </p>
      </div>

      <div class="answer-container">
        <ion-item>
          <ion-input 
            label="Traduction" 
            [(ngModel)]="currentAnswer" 
            (keyup.enter)="submitAnswer()"
            [disabled]="quizItems[currentIndex].isCorrect !== null || quizItems[currentIndex].revealed"
            placeholder="Écrivez votre réponse..."></ion-input>
        </ion-item>
        
        <ion-button 
          expand="block" 
          color="primary" 
          (click)="submitAnswer()"
          [disabled]="!currentAnswer || quizItems[currentIndex].isCorrect !== null || quizItems[currentIndex].revealed">
          Valider
        </ion-button>
        
        <div *ngIf="quizItems[currentIndex].isCorrect === null && !quizItems[currentIndex].revealed" class="help-buttons">
          <ion-button 
            expand="block" 
            fill="outline" 
            color="medium" 
            (click)="showAnswer()">
            Voir la réponse
          </ion-button>
        </div>
        
        <div *ngIf="quizItems[currentIndex].revealed" class="revealed-answer">
          <p>Réponse: {{ quizItems[currentIndex].targetWord }}</p>
          <ion-button expand="block" color="tertiary" (click)="nextWord()">
            Mot suivant
          </ion-button>
        </div>
      </div>
    </div>

    <div *ngIf="quizCompleted" class="results-container ion-padding ion-text-center">
      <h2>Exercice terminé!</h2>
      <div class="score-container">
        <ion-icon name="ribbon"></ion-icon>
        <h3>Score: {{ getScore() | number:'1.0-0' }}%</h3>
      </div>

      <!-- Résumé des erreurs -->
      <div *ngIf="hasErrors()" class="error-summary-section ion-margin-vertical">
        <ion-button 
          expand="block" 
          color="danger" 
          (click)="toggleErrorSummary()"
          class="ion-margin-bottom">
          <ion-icon [name]="showErrorSummary ? 'eye-off-outline' : 'eye-outline'" slot="start"></ion-icon>
          {{ showErrorSummary ? 'Masquer mes erreurs' : 'Voir mes erreurs' }}
        </ion-button>
        
        <ion-list *ngIf="showErrorSummary" class="error-list">
          <ion-item-divider color="light">
            <ion-label>
              Mots à réviser ({{ errorList.length }})
            </ion-label>
          </ion-item-divider>
          
          <ion-item *ngFor="let error of errorList" class="error-item">
            <ion-label>
              <h2>{{ error.sourceWord }}</h2>
              <p *ngIf="error.context" class="context-error">Contexte: {{ error.context }}</p>
              <div class="error-details">
                <div class="user-answer">
                  <ion-label color="medium">Votre réponse:</ion-label>
                  <p>{{ error.userAnswer }}</p>
                </div>
                <div class="correct-answer">
                  <ion-label color="success">Réponse correcte:</ion-label>
                  <p>{{ error.targetWord }}</p>
                </div>
              </div>
            </ion-label>
          </ion-item>
        </ion-list>
      </div>

      <h3 class="ion-padding-top">Exercices disponibles</h3>
      
      <!-- Boutons de recommencement -->
      <div class="exercise-option" (click)="restartExercise()">
        Recommencer l'exercice
      </div>
      
      <div 
        class="exercise-option"
        [class.disabled]="!hasErrors()"
        (click)="hasErrors() && restartFailedWords()">
        Recommencer les mots ratés ({{ errorList.length }})
      </div>
      
      <div 
        class="exercise-option"
        [class.disabled]="generatingComprehension"
        (click)="!generatingComprehension && requestComprehension('written')">
        Compréhension écrite
      </div>
      
      <div 
        class="exercise-option"
        [class.disabled]="generatingComprehension"
        (click)="!generatingComprehension && requestComprehension('oral')">
        Compréhension orale
      </div>
      
      <!-- Indicateur de chargement -->
      <div *ngIf="generatingComprehension" class="loading-container ion-text-center ion-margin-vertical">
        <ion-spinner></ion-spinner>
        <p>Génération du texte de compréhension...</p>
      </div>
      
      <div class="exercise-option" (click)="finishExercise()">
        Retour aux catégories
      </div>
      
      <div class="exercise-option" (click)="navigateToHome()">
        Retour à l'accueil
      </div>
    </div>
  </div>
</ion-content>
