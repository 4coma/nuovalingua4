<ion-header>
  <!-- <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="goHome()">
        <ion-icon name="arrow-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Pr√©f√©rences</ion-title>
  </ion-toolbar> -->
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="key-outline" slot="start"></ion-icon>
        Cl√© API OpenAI
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Une cl√© API open AI est n√©cessaire pour la g√©n√©ration des textes de compr√©hension √©crite et orale.</p>
      </ion-text>
      
      <ion-item>
        <ion-label position="stacked">Cl√© API OpenAI</ion-label>
        <ion-input 
          [(ngModel)]="openaiApiKey" 
          [type]="showApiKey ? 'text' : 'password'"
          placeholder="sk-..."
          class="api-key-input">
        </ion-input>
        <ion-button 
          fill="clear" 
          slot="end" 
          (click)="toggleApiKeyVisibility()">
          <ion-icon [name]="showApiKey ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
        </ion-button>
      </ion-item>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>Votre cl√© API est stock√©e localement sur votre appareil.</small></p>
      </ion-text>
      
      <ion-button fill="clear" color="primary" size="small" (click)="showApiKeyInfo()" class="ion-margin-top">
        <ion-icon name="information-circle-outline" slot="start"></ion-icon>
        Pourquoi configurer ma cl√© API ?
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="ear-outline" slot="start"></ion-icon>
        Notification compr√©hension orale
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Recevez chaque jour un court exercice de compr√©hension orale.</p>
      </ion-text>

      <ion-item>
        <ion-label>Activer</ion-label>
        <ion-toggle [(ngModel)]="comprehensionNotificationsEnabled" (ionChange)="onComprehensionNotificationToggleChange()"></ion-toggle>
      </ion-item>

      <ion-item *ngIf="comprehensionNotificationsEnabled">
        <ion-label position="stacked">Heure</ion-label>
        <ion-input type="time" [(ngModel)]="comprehensionNotificationTime" (ionChange)="onComprehensionNotificationTimeChange()"></ion-input>
      </ion-item>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="volume-high-outline" slot="start"></ion-icon>
        Cl√© API Google Text-to-Speech
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Entrez votre cl√© API Google Text-to-Speech pour activer la prononciation des mots italiens dans le jeu d'association.</p>
      </ion-text>
      
      <ion-item>  
        <ion-label position="stacked">Cl√© API Google TTS</ion-label>
        <ion-input 
          [(ngModel)]="googleTtsApiKey" 
          [type]="showGoogleApiKey ? 'text' : 'password'"
          placeholder="AIza..."
          class="api-key-input">
        </ion-input>
        <ion-button 
          fill="clear" 
          slot="end" 
          (click)="toggleGoogleApiKeyVisibility()">
          <ion-icon [name]="showGoogleApiKey ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
        </ion-button>
      </ion-item>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>Votre cl√© API est stock√©e localement sur votre appareil.</small></p>
      </ion-text>
      
      <ion-button fill="clear" color="primary" size="small" (click)="showGoogleApiKeyInfo()" class="ion-margin-top">
        <ion-icon name="information-circle-outline" slot="start"></ion-icon>
        Comment obtenir ma cl√© API Google TTS ?
      </ion-button>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="cloud-outline" slot="start"></ion-icon>
        Synchronisation Firebase
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Configurez Firebase pour synchroniser vos donn√©es (dictionnaire personnel, statistiques) entre vos appareils.</p>
      </ion-text>
      
      <ion-item>
        <ion-label>Activer la synchronisation Firebase</ion-label>
        <ion-toggle [(ngModel)]="firebaseEnabled"></ion-toggle>
      </ion-item>
      
      <div *ngIf="firebaseEnabled">
        <ion-item>
          <ion-label position="stacked">API Key</ion-label>
          <ion-input 
            [(ngModel)]="firebaseApiKey" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="AIza..."
            class="api-key-input">
          </ion-input>
          <ion-button 
            fill="clear" 
            slot="end" 
            (click)="toggleFirebaseConfigVisibility()">
            <ion-icon [name]="showFirebaseConfig ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          </ion-button>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Auth Domain</ion-label>
          <ion-input 
            [(ngModel)]="firebaseAuthDomain" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="votre-projet.firebaseapp.com">
          </ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Project ID</ion-label>
          <ion-input 
            [(ngModel)]="firebaseProjectId" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="votre-projet-id">
          </ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Storage Bucket</ion-label>
          <ion-input 
            [(ngModel)]="firebaseStorageBucket" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="votre-projet.appspot.com">
          </ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">Messaging Sender ID</ion-label>
          <ion-input 
            [(ngModel)]="firebaseMessagingSenderId" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="123456789">
          </ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">App ID</ion-label>
          <ion-input 
            [(ngModel)]="firebaseAppId" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="1:123456789:web:abcdef">
          </ion-input>
        </ion-item>
        
        <ion-item>
          <ion-label position="stacked">UID Firebase personnalis√© (optionnel)</ion-label>
          <ion-input 
            [(ngModel)]="firebaseCustomUid" 
            [type]="showFirebaseConfig ? 'text' : 'password'"
            placeholder="Laissez vide pour UID automatique">
          </ion-input>
        </ion-item>
        
        <ion-text color="medium" class="ion-padding-top">
          <p><small>Votre configuration Firebase est stock√©e localement sur votre appareil.</small></p>
          <p><small><strong>UID personnalis√© :</strong> Utilisez le m√™me UID sur tous vos appareils pour synchroniser les donn√©es. Laissez vide pour un UID automatique unique par appareil.</small></p>
        </ion-text>
        
        <ion-button fill="clear" color="primary" size="small" (click)="showFirebaseInfo()" class="ion-margin-top">
          <ion-icon name="information-circle-outline" slot="start"></ion-icon>
          Comment obtenir ma configuration Firebase ?
        </ion-button>
        
        <ion-button 
          expand="block" 
          color="success" 
          fill="outline"
          (click)="testFirebaseConnection()"
          class="ion-margin-top">
          <ion-icon name="checkmark-circle-outline" slot="start"></ion-icon>
          Tester la connexion Firebase
        </ion-button>
        
        <ion-button 
          expand="block" 
          color="primary" 
          fill="outline"
          (click)="migrateDataToFirebase()"
          class="ion-margin-top">
          <ion-icon name="cloud-upload-outline" slot="start"></ion-icon>
          Migrer mes donn√©es vers Firebase
        </ion-button>
        
        <ion-button 
          expand="block" 
          color="medium" 
          fill="clear"
          (click)="showMigrationInfo()"
          class="ion-margin-top">
          <ion-icon name="information-circle-outline" slot="start"></ion-icon>
          √Ä propos de la migration
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="game-controller-outline" slot="start"></ion-icon>
        Nombre d'associations de mots
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Choisissez le nombre de paires de mots g√©n√©r√©es lors du d√©marrage d'une session d'apprentissage.</p>
      </ion-text>
      
      <ion-item>
        <ion-label position="stacked">Nombre d'associations</ion-label>
        <ion-input 
          [(ngModel)]="wordAssociationsCount" 
          type="number" 
          min="1" 
          max="100"
          placeholder="Ex: 12"
          class="associations-input">
        </ion-input>
      </ion-item>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>Saisissez le nombre exact d'associations souhait√©es (1-100).</small></p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="mic-outline" slot="start"></ion-icon>
        Longueur des compr√©hensions orales
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>D√©finissez la longueur des textes g√©n√©r√©s pour les exercices de compr√©hension orale.</p>
      </ion-text>
      
      <ion-item>
        <ion-label position="stacked">Nombre de mots</ion-label>
        <ion-input 
          [(ngModel)]="oralComprehensionLength" 
          type="number" 
          min="50" 
          max="500"
          placeholder="Ex: 150"
          class="length-input">
        </ion-input>
      </ion-item>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>Choisissez entre 50 et 500 mots pour adapter la dur√©e d'√©coute √† votre niveau (50-500 mots).</small></p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="bulb-outline" slot="start"></ion-icon>
        Contextes personnalis√©s pour la compr√©hension quotidienne
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Ajoutez des contextes ou sc√©narios pour guider la g√©n√©ration de la compr√©hension quotidienne. Un contexte sera s√©lectionn√© al√©atoirement chaque jour.</p>
      </ion-text>
      
      <div *ngFor="let theme of dailyComprehensionThemes; let i = index" class="theme-item">
        <ion-item>
          <ion-textarea 
            [(ngModel)]="dailyComprehensionThemes[i]" 
            placeholder="Ex: le texte doit √™tre autour de deux personnes qui se disputent dans leur voiture sur un rond-point..."
            rows="2"
            class="theme-textarea">
          </ion-textarea>
          <ion-button 
            fill="clear" 
            color="danger" 
            slot="end" 
            (click)="removeDailyTheme(i)"
            *ngIf="dailyComprehensionThemes.length > 1">
            <ion-icon name="trash-outline"></ion-icon>
          </ion-button>
        </ion-item>
      </div>
      
      <ion-button 
        expand="block" 
        fill="outline" 
        color="primary" 
        (click)="addDailyTheme()"
        class="ion-margin-top">
        <ion-icon name="add-outline" slot="start"></ion-icon>
        Ajouter un contexte
      </ion-button>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>Les contextes sont sauvegard√©s automatiquement. Si aucun contexte n'est d√©fini, le texte sera g√©n√©r√© sans consigne particuli√®re.</small></p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="book-outline" slot="start"></ion-icon>
        R√©vision du dictionnaire personnel
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>D√©finissez le nombre de mots s√©lectionn√©s al√©atoirement lors de la r√©vision de votre dictionnaire personnel.</p>
      </ion-text>
      
      <ion-item>
        <ion-label position="stacked">Nombre de mots par session</ion-label>
        <ion-input 
          [(ngModel)]="personalDictionaryWordsCount" 
          type="number" 
          min="3" 
          max="20"
          placeholder="Ex: 8"
          class="personal-dictionary-input">
        </ion-input>
      </ion-item>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>Choisissez entre 3 et 20 mots pour adapter la dur√©e de la session √† votre disponibilit√© (3-20 mots).</small></p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>
        <ion-icon name="notifications-outline" slot="start"></ion-icon>
        Notifications quotidiennes
      </ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <ion-text color="medium">
        <p>Recevez une notification quotidienne pour vous rappeler de pratiquer votre italien.</p>
      </ion-text>
      
      <ion-item>
        <ion-label>Activer les notifications quotidiennes</ion-label>
        <ion-toggle 
          [(ngModel)]="notificationsEnabled" 
          (ionChange)="onNotificationToggleChange()">
        </ion-toggle>
      </ion-item>
      
      <ion-item *ngIf="notificationsEnabled">
        <ion-label position="stacked">Heure de la notification</ion-label>
        <ion-input 
          [(ngModel)]="notificationTime" 
          type="time"
          (ionChange)="onNotificationTimeChange()">
        </ion-input>
      </ion-item>
      
      <ion-item *ngIf="notificationsEnabled">
        <ion-label position="stacked">Message de la notification</ion-label>
        <ion-textarea 
          [(ngModel)]="notificationMessage" 
          placeholder="Il est temps de pratiquer votre italien ! üáÆüáπ"
          rows="2"
          (ionChange)="onNotificationMessageChange()">
        </ion-textarea>
      </ion-item>
      
      <ion-button 
        *ngIf="notificationsEnabled"
        expand="block" 
        color="success" 
        (click)="sendTestNotification()"
        class="ion-margin-top">
        <ion-icon name="send-outline" slot="start"></ion-icon>
        Envoyer une notification de test
      </ion-button>
      
      <ion-button 
        expand="block" 
        color="warning" 
        fill="outline"
        (click)="checkNotificationPermissions()"
        class="ion-margin-top">
        <ion-icon name="shield-checkmark-outline" slot="start"></ion-icon>
        V√©rifier les permissions
      </ion-button>
      
      <ion-text color="medium" class="ion-padding-top">
        <p><small>La notification sera envoy√©e quotidiennement √† l'heure choisie pour vous rappeler de pratiquer.</small></p>
        <p><small><strong>Note :</strong> Sur Android 12+, vous devez autoriser les "Alarmes et rappels" dans les param√®tres syst√®me pour que les notifications exactes fonctionnent.</small></p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <div class="ion-padding-top">
    <ion-button 
      expand="block" 
      color="primary" 
      (click)="savePreferences()"
      class="ion-margin-bottom">
      <ion-icon name="save-outline" slot="start"></ion-icon>
      Sauvegarder les pr√©f√©rences
    </ion-button>
    
    <ion-button 
      expand="block" 
      color="medium" 
      fill="outline"
      (click)="resetPreferences()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      R√©initialiser aux valeurs par d√©faut
    </ion-button>

    <ion-button 
      expand="block" 
      color="danger" 
      fill="outline"
      (click)="clearVocabulary()">
      <ion-icon name="trash-outline" slot="start"></ion-icon>
      Effacer tout le vocabulaire
    </ion-button>
  </div>
</ion-content> 